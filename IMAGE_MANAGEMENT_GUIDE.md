# 图片管理功能使用指南

## 概述

本系统现已支持完整的图片上传和管理功能，可以为房间、餐厅和菜系绑定封面图片。

## 主要功能

### 1. 图片上传

- 支持单张或多张图片同时上传
- 支持的格式：JPEG, JPG, PNG, GIF, WEBP
- 单个文件大小限制：5MB
- 自动处理中文文件名，避免乱码问题

### 2. 图片管理

在管理后台的"内容管理"页面，选择"图片管理"标签：

- **上传图片**：点击"上传图片"按钮，选择本地图片文件
- **查看图片**：所有已上传的图片以网格形式展示
- **复制链接**：鼠标悬停在图片上，点击复制图标可复制图片URL
- **删除图片**：
  - 单张删除：鼠标悬停在图片上，点击删除图标
  - 批量删除：选中多张图片后，点击"删除选中"按钮

### 3. 绑定图片到内容

#### 房间类型封面

1. 进入"内容管理" > "房间内容"
2. 点击要编辑的房间类型
3. 在弹出的编辑窗口中，找到"房间图片"部分
4. 点击"选择图片"按钮
5. 从图片库中选择一张或多张图片
6. 点击"确认选择"
7. 保存房间类型

#### 菜系封面

1. 进入"内容管理" > "餐厅内容"
2. 在"菜系管理"部分，点击"添加菜系"或编辑现有菜系
3. 在弹出的窗口中，找到"菜系封面"部分
4. 点击"选择封面图片"按钮
5. 从图片库中选择一张图片
6. 点击"确认选择"
7. 保存菜系

#### 餐厅内容图片

餐厅内容的图片需要通过API直接设置到content_sections表的images字段中。

## 技术实现

### 后端

1. **文件存储**：
   - 上传的文件保存在 `server/uploads/` 目录
   - 文件名格式：`时间戳-随机数-原始文件名`
   - 支持中文文件名的正确编码

2. **数据库记录**：
   - `uploaded_files` 表存储所有上传文件的元数据
   - `room_types.images` 字段存储房间图片路径数组（JSONB）
   - `cuisines.image_url` 字段存储菜系封面路径（VARCHAR）

3. **API端点**：
   - `POST /api/upload/image` - 上传单张图片
   - `POST /api/upload/images` - 上传多张图片
   - `GET /api/upload/images` - 获取图片列表
   - `DELETE /api/upload/image/:id` - 删除单张图片
   - `DELETE /api/upload/images` - 批量删除图片

### 前端

1. **图片URL处理**：
   - 相对路径自动拼接API基础URL
   - 支持完整HTTP/HTTPS URL
   - 示例：`/uploads/xxx.jpg` → `http://localhost:3000/uploads/xxx.jpg`

2. **组件**：
   - `ImageManager.vue` - 图片管理组件
   - `ContentManagement.vue` - 内容管理（包含图片选择器）
   - `RoomGallery.vue` - 房间展示（显示房间图片）
   - `RestaurantGallery.vue` - 餐厅展示（显示餐厅图片）

## 常见问题

### Q: 上传的图片显示乱码？

A: 已修复。系统现在正确处理中文文件名，使用UTF-8编码。

### Q: 图片无法显示？

A: 检查以下几点：

1. 确保后端服务器正在运行
2. 检查 `.env` 文件中的 `VITE_API_BASE_URL` 配置是否正确
3. 确认图片路径格式正确（应该是 `/uploads/文件名`）
4. 检查浏览器控制台是否有CORS错误

### Q: 如何更换房间或菜系的封面图片？

A:

1. 编辑对应的房间类型或菜系
2. 如果已有图片，先点击图片上的删除按钮移除
3. 点击"选择图片"按钮选择新图片
4. 保存更改

## 数据库迁移

如果是从旧版本升级，需要运行以下迁移脚本：

```bash
# 进入服务器目录
cd server

# 运行迁移
psql -U your_username -d your_database -f src/db/migrations/add_cuisines_updated_at.sql
```

## 权限要求

- 图片上传、删除：需要管理员权限
- 图片查看：需要登录
- 前端展示：无需认证

## 最佳实践

1. **图片优化**：上传前建议压缩图片，保持文件大小在1MB以下
2. **命名规范**：使用有意义的文件名，便于管理
3. **定期清理**：删除不再使用的图片，节省存储空间
4. **备份**：定期备份 `uploads` 目录
